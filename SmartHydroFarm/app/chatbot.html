<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>AI Chat (Messenger Style)</title>

  <!-- Markdown renderer (optional, same as your old code) -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;

      --bubble-user:#2563eb;    /* Messenger-ish blue */
      --bubble-user-text:#ffffff;

      --bubble-bot:#ffffff;
      --bubble-bot-text:#111827;

      --shadow:0 10px 30px rgba(17,24,39,.08);
      --radius:18px;
    }

    *{box-sizing:border-box;margin:0;padding:0;font-family:Arial,sans-serif}
    body{height:100vh;background:var(--bg);color:var(--text);overflow:hidden}

    /* No top header â€“ your app has its own */
    .chat-page{
      height:100vh;
      display:flex;
      flex-direction:column;
    }

    /* Main chat area */
    .chat-area{
      flex:1;
      overflow-y:auto;
      padding:12px 12px 10px;
      scroll-behavior:smooth;
    }

    /* Date / info chips */
    .chip{
      width:max-content;
      margin:10px auto;
      padding:7px 12px;
      border-radius:999px;
      background:#fff;
      border:1px solid var(--border);
      color:var(--muted);
      font-size:11px;
      font-weight:800;
      box-shadow:0 6px 18px rgba(17,24,39,.04);
    }

    /* Rows */
    .row{
      display:flex;
      gap:8px;
      margin:10px 0;
      align-items:flex-end;
    }
    .row.user{justify-content:flex-end}
    .row.bot{justify-content:flex-start}

    /* Avatar (bot only) */
    .avatar{
      width:30px;height:30px;border-radius:999px;
      background:#111827;
      color:#fff;
      display:flex;align-items:center;justify-content:center;
      font-size:14px;
      flex:0 0 auto;
      box-shadow:0 8px 20px rgba(17,24,39,.12);
    }

    /* Bubbles */
    .bubble{
      max-width:78%;
      padding:10px 12px;
      border-radius:18px;
      line-height:1.35;
      font-size:13px;
      box-shadow:0 10px 20px rgba(17,24,39,.06);
      word-wrap:break-word;
      overflow-wrap:anywhere;
    }

    .bubble.user{
      background:var(--bubble-user);
      color:var(--bubble-user-text);
      border-bottom-right-radius:6px;
    }

    .bubble.bot{
      background:var(--bubble-bot);
      color:var(--bubble-bot-text);
      border:1px solid var(--border);
      border-bottom-left-radius:6px;
    }

    .meta{
      margin-top:6px;
      font-size:10px;
      color:rgba(255,255,255,.85);
      opacity:.9;
    }
    .bot-meta{
      margin-top:6px;
      font-size:10px;
      color:var(--muted);
      opacity:.9;
    }

    /* Markdown inside bot bubble */
    .bubble.bot p{margin:0 0 8px}
    .bubble.bot p:last-child{margin-bottom:0}
    .bubble.bot pre{
      background:#0b0f19;
      color:#a7f3d0;
      border-radius:14px;
      padding:10px;
      overflow:auto;
      font-size:11px;
      border:1px solid rgba(255,255,255,.08);
    }
    .bubble.bot code{
      background:#f3f4f6;
      border:1px solid #e5e7eb;
      padding:1px 5px;
      border-radius:8px;
      font-size:12px;
    }
    .bubble.bot blockquote{
      border-left:3px solid #d1d5db;
      padding-left:10px;
      color:#374151;
      margin:6px 0;
    }
    .bubble.bot ul{margin:6px 0 6px 18px}
    .bubble.bot li{margin:4px 0}

    /* Typing indicator */
    .typing{
      display:flex;
      gap:6px;
      align-items:center;
      padding:10px 12px;
      border-radius:18px;
      background:#fff;
      border:1px solid var(--border);
      box-shadow:0 10px 20px rgba(17,24,39,.06);
      max-width:180px;
    }
    .dot{
      width:6px;height:6px;border-radius:999px;
      background:#9ca3af;
      animation:bounce 1.2s infinite ease-in-out;
    }
    .dot:nth-child(2){animation-delay:.15s}
    .dot:nth-child(3){animation-delay:.3s}
    @keyframes bounce{
      0%,80%,100%{transform:translateY(0);opacity:.6}
      40%{transform:translateY(-4px);opacity:1}
    }

    /* Composer (Messenger-ish) */
    .composer{
      padding:10px 10px 12px;
      background:rgba(246,247,251,.92);
      backdrop-filter: blur(6px);
      border-top:1px solid var(--border);
    }
    .composer-row{
      display:flex;
      gap:8px;
      align-items:flex-end;
    }
    .input{
      flex:1;
      background:#fff;
      border:1px solid var(--border);
      border-radius:999px;
      padding:10px 12px;
      display:flex;
      gap:8px;
      align-items:center;
      box-shadow:0 10px 20px rgba(17,24,39,.05);
    }
    textarea{
      flex:1;
      border:none;
      outline:none;
      resize:none;
      font-size:13px;
      line-height:1.35;
      max-height:120px;
      background:transparent;
      color:var(--text);
    }

    .btn{
      width:42px;height:42px;border-radius:999px;
      border:none;
      cursor:pointer;
      font-weight:900;
      background:var(--bubble-user);
      color:#fff;
      display:flex;align-items:center;justify-content:center;
      box-shadow:0 10px 24px rgba(37,99,235,.25);
      transition:transform .08s, filter .2s;
      flex:0 0 auto;
    }
    .btn:active{transform:translateY(1px)}
    .btn:disabled{opacity:.6;cursor:not-allowed;box-shadow:none}

    .hint{
      margin-top:8px;
      font-size:11px;
      color:var(--muted);
      text-align:center;
    }

    /* Safe area for iOS */
    .safe-bottom{
      height: env(safe-area-inset-bottom);
    }
  </style>
</head>

<body>
  <div class="chat-page">
    <div class="chat-area" id="chatArea">
      <div class="chip">SHVF AI Support </div>

      <!-- Example starter message -->
      <div class="row bot">
        <div class="avatar">AI</div>
        <div class="bubble bot">
          Hi! ðŸ‘‹ Send your question about your hydroponics system (pH, TDS, relays, schedules, etc.).
          <div class="bot-meta">Tip: You can send Taglish.</div>
        </div>
      </div>
    </div>

    <div class="composer">
      <div class="composer-row">
        <div class="input">
          <textarea id="chatInput" rows="1" placeholder="Message..." autocomplete="off"></textarea>
        </div>
        <button class="btn" id="sendBtn" title="Send">âž¤</button>
      </div>
      <div class="hint" id="hintLine"></div>
      <div class="safe-bottom"></div>
    </div>
  </div>

  <script>
    /* ============================================================
      MESSENGER-STYLE AI CHAT PAGE (APP)
      - Mobile-first
      - Uses /api/chat.php (same as your old code)
      - Optional Markdown rendering for bot replies (marked)
      - Exposes functions so your app shell can inject JWT if needed later
    ============================================================ */

    const CHAT_ENDPOINT = "https://smarthydrofarm.com/api/chat.php";

    // Optional: JWT variable (NOT required unless your chat.php needs it)
    let JWT_TOKEN = ""; // set via SHVF_CHAT.setJwtToken("...")

    const chatArea = document.getElementById("chatArea");
    const chatInput = document.getElementById("chatInput");
    const sendBtn = document.getElementById("sendBtn");
    const hintLine = document.getElementById("hintLine");

    function setHint(txt){
      hintLine.textContent = txt || "";
    }

    function scrollToBottom(){
      chatArea.scrollTop = chatArea.scrollHeight;
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function addUserBubble(text){
      const row = document.createElement("div");
      row.className = "row user";

      const bubble = document.createElement("div");
      bubble.className = "bubble user";
      bubble.innerHTML = escapeHtml(text);

      row.appendChild(bubble);
      chatArea.appendChild(row);
      scrollToBottom();
    }

    function addBotBubble(htmlOrText, isHtml=true){
      const row = document.createElement("div");
      row.className = "row bot";

      const avatar = document.createElement("div");
      avatar.className = "avatar";
      avatar.textContent = "AI";

      const bubble = document.createElement("div");
      bubble.className = "bubble bot";

      if (isHtml) bubble.innerHTML = htmlOrText;
      else bubble.textContent = htmlOrText;

      row.appendChild(avatar);
      row.appendChild(bubble);
      chatArea.appendChild(row);
      scrollToBottom();
    }

    function addTyping(){
      const row = document.createElement("div");
      row.className = "row bot";
      row.id = "typingRow";

      const avatar = document.createElement("div");
      avatar.className = "avatar";
      avatar.textContent = "AI";

      const typing = document.createElement("div");
      typing.className = "typing";
      typing.innerHTML = `<div class="dot"></div><div class="dot"></div><div class="dot"></div>`;

      row.appendChild(avatar);
      row.appendChild(typing);
      chatArea.appendChild(row);
      scrollToBottom();
    }

    function removeTyping(){
      const el = document.getElementById("typingRow");
      if (el) el.remove();
    }

    function autoGrowTextarea(){
      chatInput.style.height = "auto";
      const next = Math.min(chatInput.scrollHeight, 120);
      chatInput.style.height = next + "px";
    }

    async function sendMessage(){
      const msg = (chatInput.value || "").trim();
      if (!msg) return;

      addUserBubble(msg);
      chatInput.value = "";
      autoGrowTextarea();

      sendBtn.disabled = true;
      addTyping();

      try{
        // Using FormData like your original implementation
        const fd = new FormData();
        fd.append("message", msg);

        const headers = {};
        // If you ever want JWT-protect chat.php, enable this:
        if (JWT_TOKEN) headers["Authorization"] = "Bearer " + JWT_TOKEN;

        const res = await fetch(CHAT_ENDPOINT, {
          method: "POST",
          body: fd,
          headers
        });

        const text = await res.text();
        if (!res.ok) throw new Error(`HTTP ${res.status}: ${text || "(no body)"}`);

        let data;
        try{ data = JSON.parse(text); }
        catch(e){ throw new Error("Invalid JSON: " + text); }

        removeTyping();
        sendBtn.disabled = false;

        // Same OpenAI-ish shape as your old code:
        // data.choices[0].message.content
        const reply = data?.choices?.[0]?.message?.content;

        if (reply){
          const html = (window.marked ? marked.parse(reply) : escapeHtml(reply));
          addBotBubble(html, true);
          // you had provider shown previously; show as hint
          const provider = data?.provider ? ("Model: " + data.provider) : "Connected";
          setHint(provider);
        } else {
          addBotBubble("Hey grower! ðŸŒ¾ The assistant is unavailable right now. Try again in a moment.", false);
          setHint("No reply");
        }

      }catch(err){
        console.error(err);
        removeTyping();
        sendBtn.disabled = false;
        addBotBubble("Error: " + err.message, false);
        setHint("Error");
      }

      scrollToBottom();
    }

    // Send on button
    sendBtn.addEventListener("click", sendMessage);

    // Enter to send, Shift+Enter newline
    chatInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey){
        e.preventDefault();
        sendMessage();
      }
    });

    chatInput.addEventListener("input", autoGrowTextarea);
    autoGrowTextarea();

    /* ============================================================
      EXPOSE API FOR YOUR APP SHELL
    ============================================================ */
    window.SHVF_CHAT = window.SHVF_CHAT || {};

    window.SHVF_CHAT.setJwtToken = function(token){
      JWT_TOKEN = (token || "").trim();
      setHint(JWT_TOKEN ? "JWT set (if chat requires it)" : "Connected");
    };

    window.SHVF_CHAT.getJwtToken = function(){
      return JWT_TOKEN;
    };

    window.SHVF_CHAT.send = function(text){
      chatInput.value = String(text || "");
      autoGrowTextarea();
      sendMessage();
    };

    window.SHVF_CHAT.clear = function(){
      // Keeps the starter chip + welcome message? You can wipe everything if you want.
      const keep = [];
      [...chatArea.children].forEach((el, idx) => {
        // Keep first 2 nodes (chip + welcome)
        if (idx < 2) keep.push(el);
      });
      chatArea.innerHTML = "";
      keep.forEach(k => chatArea.appendChild(k));
      setHint("Cleared");
      scrollToBottom();
    };
  </script>
</body>
</html>