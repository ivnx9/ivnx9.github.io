<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>SHVF Dashboard (App)</title>

  <!-- Keep this (required by your gauge code) -->
  <script src="gauge.js"></script>

  <style>
    :root{
      --bg:#ffffff;
      --card:#ffffff;
      --border:#e5e7eb;
      --text:#111827;
      --muted:#6b7280;
      --shadow: 0 6px 18px rgba(0,0,0,.06);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      padding:14px;
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow: var(--shadow);
    }

    /* Summary */
    .summary{
      padding: 12px 12px 10px;
      margin-bottom: 12px;
    }
    .summary-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .summary-left{
      display:flex;
      flex-direction:column;
      gap:3px;
      min-width:0;
    }
    .summary-title{
      font-size: 14px;
      font-weight: 700;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .summary-sub{
      font-size: 12px;
      color: var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .pill{
      font-size: 11px;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid var(--border);
      color: var(--muted);
      background:#f9fafb;
      white-space:nowrap;
    }

    .status-grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:10px;
      margin-top:10px;
    }
    .mini{
      padding:10px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#fbfbfb;
      box-shadow:none;
      text-align:left;
    }
    .mini .k{ font-size:11px; color:var(--muted); }
    .mini .v{ margin-top:4px; font-size:13px; font-weight:700; }

    /* CCTV + Windy cards */
    .section-title{
      font-size:12px;
      font-weight:700;
      color: var(--text);
      margin: 2px 0 10px;
    }
    .media-card{
      padding: 12px;
      margin-bottom: 12px;
    }
    .snapshot{
      width:100%;
      border-radius: 12px;
      border: 1px solid var(--border);
      display:block;
      background:#f3f4f6;
      aspect-ratio: 16/9;
      object-fit: cover;
    }
    .iframe-wrap{
      width:100%;
      border-radius:12px;
      border: 1px solid var(--border);
      overflow:hidden;
      background:#f3f4f6;
    }
    .iframe-wrap iframe{
      width:100%;
      height: 240px;
      border:0;
      display:block;
    }
    .hint{
      margin-top:8px;
      font-size:12px;
      color: var(--muted);
      line-height:1.4;
    }

    /* Trend card */
    .trend-card{
      padding: 12px;
      margin-bottom: 12px;
    }
    .trend-head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
    }
    .trend-legend{
      font-size:11px;
      color: var(--muted);
      line-height:1.4;
      text-align:right;
      white-space:nowrap;
    }
    #trendSvg{
      width:100%;
      height:130px;
      display:block;
      border-radius:12px;
      border:1px solid var(--border);
      background:#fbfbfb;
    }

    /* Gauges */
    .grid{
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
      align-items: start;
      margin-bottom: 10px;
    }
    .gcard{
      padding: 8px 6px;
      text-align:center;
    }
    canvas{ width:150px; height:150px; }

    @media (max-width: 420px){
      body{ padding:12px; }
      .grid{ gap: 8px; }
      canvas{ width:145px; height:145px; }
      .iframe-wrap iframe{ height: 220px; }
    }
  </style>

  <script>
    // =========================
    // YOUR GAUGE ENGINE (UNCHANGED)
    // =========================
    const gauges = {};

    function createGauge(canvasId, options) {
      const el = document.getElementById(canvasId);
      if (!el) { console.error("Canvas not found:", canvasId); return null; }

      const g = new Gauge(Object.assign({
        renderTo: canvasId,
        width: 150,
        height: 150,
        glow: true,
        strokeTicks: false,
        animation: { delay: 10, duration: 300, fn: "bounce" }
      }, options));

      g.draw();
      gauges[canvasId] = g;
      return g;
    }

    function DrawGauge_Air(canvasId, title) {
      const minValue = -20, maxValue = 50;
      return createGauge(canvasId, {
        units: "°C",
        title: title ?? "Air Temperature",
        minValue, maxValue,
        majorTicks: ["-20","0","10","15","20","25","30","35","40","45","50"],
        minorTicks: 5,
        highlights: [
          { from: minValue, to: 0, color: "rgba(0,0,255,.3)" },
          { from: 0, to: maxValue, color: "rgba(255,0,0,.3)" }
        ],
        colors: {
          plate: "#f5f5f5",
          majorTicks: "#000",
          minorTicks: "#222",
          title: "#222",
          units: "#666",
          numbers: "#222",
          needle: { start: "rgba(240,128,128,1)", end: "rgba(255,160,122,.9)" }
        },
        animation: { delay: 25, duration: 500, fn: "bounce" }
      });
    }

    function DrawGauge_WaterTemp(canvasId, title) {
      const minValue = -20, maxValue = 80;
      return createGauge(canvasId, {
        units: "°C",
        title: title ?? "Water Temperature",
        minValue, maxValue,
        majorTicks: ["-20","0","20","40","60","80"],
        minorTicks: 5,
        highlights: [
          { from: minValue, to: 0, color: "rgba(0,0,255,.3)" },
          { from: 0, to: maxValue, color: "rgba(255,0,0,.3)" }
        ],
        colors: {
          plate: "#f5f5f5",
          majorTicks: "#000",
          minorTicks: "#222",
          title: "#222",
          units: "#666",
          numbers: "#222",
          needle: { start: "rgba(240,128,128,1)", end: "rgba(255,160,122,.9)" }
        },
        animation: { delay: 25, duration: 500, fn: "bounce" }
      });
    }

    function DrawGaugePh(canvasId, title) {
      return createGauge(canvasId, {
        units: "",
        title: title ?? "pH Level",
        minValue: 0,
        maxValue: 10,
        majorTicks: ["0","1","2","3","4","5","6","7","8","9","10"],
        minorTicks: 5,
        highlights: [
          { from: 0, to: 4, color: "PaleGreen" },
          { from: 4, to: 7, color: "Khaki" },
          { from: 7, to: 10, color: "LightSalmon" }
        ]
      });
    }

    function DrawGaugeTds(canvasId, title) {
      return createGauge(canvasId, {
        units: "",
        title: title ?? "TDS Level",
        minValue: 0,
        maxValue: 2500,
        majorTicks: ["0","100","200","300","400","500","600","700","800","900","1000","1500","2000","2500"],
        minorTicks: 5,
        highlights: [
          { from: 0, to: 1000, color: "PaleGreen" },
          { from: 1000, to: 1500, color: "Khaki" },
          { from: 1500, to: 2500, color: "LightSalmon" }
        ]
      });
    }

    function DrawGaugeWaterLevel(canvasId, title) {
      return createGauge(canvasId, {
        units: "",
        title: title ?? "Water Level",
        minValue: 0,
        maxValue: 200,
        majorTicks: ["0","10","20","30","40","50","60","70","80","90","100","120","130","140","150","170","180","190","200"],
        minorTicks: 5,
        highlights: [
          { from: 0, to: 50, color: "PaleGreen" },
          { from: 50, to: 150, color: "Khaki" },
          { from: 150, to: 200, color: "LightSalmon" }
        ]
      });
    }

    function DrawGaugeHumidity(canvasId, title) {
      return createGauge(canvasId, {
        units: "%",
        title: title ?? "Humidity",
        minValue: 0,
        maxValue: 100,
        majorTicks: ["0","10","20","30","40","50","60","70","80","90","100"],
        minorTicks: 5,
        highlights: [
          { from: 0,  to: 30,  color: "rgba(255,165,0,.3)" },
          { from: 30, to: 60,  color: "rgba(0,255,0,.3)" },
          { from: 60, to: 100, color: "rgba(0,0,255,.3)" }
        ]
      });
    }

    // Helper: update later from sensors (DroidScript will call this; keep it!)
    function setGaugeValue(canvasId, value) {
      if (gauges[canvasId]) gauges[canvasId].setValue(value);
    }

    // =========================
    // DASHBOARD POLLING + SNAPSHOT + TREND
    // =========================
    const API_BASE = "https://smarthydrofarm.com/api/webhook.php";
    const POLL_MS  = 3000;

    // CCTV snapshot source (adjust if needed)
    const SNAPSHOT_URL = "https://smarthydrofarm.com/api/images/SHVF-V1.jpg";
    const SNAPSHOT_MS  = 4000;

    // Windy embed config
    const latitude  = 14.5995;
    const longitude = 120.9842;

    function getActiveDevice() {
      const device_id   = "SHVF-V1";   // or localStorage.getItem("shvf_device_id")   || "SHVF-V1";
      const device_code = "12345";     // or localStorage.getItem("shvf_device_code") || "12345";
      return { device_id, device_code };
    }

    function safeNum(x){
      if (x === undefined || x === null || x === "") return null;
      const n = Number(x);
      return Number.isNaN(n) ? null : n;
    }

    function setText(id, text){
      const el = document.getElementById(id);
      if (!el) return;
      el.textContent = text;
    }

    async function fetchPanel() {
      const { device_id, device_code } = getActiveDevice();
      const url = `${API_BASE}?cmd=panel`
        + `&device_id=${encodeURIComponent(device_id)}`
        + `&device_code=${encodeURIComponent(device_code)}`;

      const res = await fetch(url);
      const txt = await res.text();
      if (!res.ok) throw new Error(`panel failed ${res.status}: ${txt || "(no body)"}`);
      try { return JSON.parse(txt); }
      catch(e){ throw new Error("invalid JSON: " + txt); }
    }

    // --- Trend history (last 20 polls) ---
    const history = { ph: [], tds: [] };

    function pushHistory(ph, tds){
      if (typeof ph === "number") history.ph.push(ph);
      if (typeof tds === "number") history.tds.push(tds);
      if (history.ph.length > 20)  history.ph  = history.ph.slice(-20);
      if (history.tds.length > 20) history.tds = history.tds.slice(-20);
    }

    function renderTrendChart(){
      const svg = document.getElementById("trendSvg");
      if (!svg) return;

      const phData  = history.ph.slice();
      const tdsData = history.tds.slice();
      const n = Math.max(phData.length, tdsData.length);
      if (n < 2) { svg.innerHTML = ""; return; }

      const W = 320, H = 130, P = 10; // viewBox units

      function mm(data){
        const vals = data.filter(v => typeof v === "number" && !Number.isNaN(v));
        if (!vals.length) return {min:0, max:1};
        let min = Math.min(...vals), max = Math.max(...vals);
        if (min === max){ min -= 1; max += 1; }
        return {min, max};
      }

      const phMM  = mm(phData);
      const tdsMM = mm(tdsData);

      function path(data, m){
        const len = data.length;
        if (len < 2) return "";
        let d = "";
        for (let i=0;i<len;i++){
          const v = (typeof data[i] === "number") ? data[i] : m.min;
          const x = P + ((W - 2*P) * (i / (len - 1)));
          const r = (v - m.min) / (m.max - m.min);
          const y = (H - P) - r * (H - 2*P);
          d += (i===0 ? "M" : "L") + x + " " + y + " ";
        }
        return d;
      }

      const phPath  = path(phData, phMM);
      const tdsPath = path(tdsData, tdsMM);

      svg.setAttribute("viewBox", `0 0 ${W} ${H}`);
      svg.innerHTML = `
        <line x1="${P}" y1="${H-P}" x2="${W-P}" y2="${H-P}" stroke="#d1d5db" stroke-width="1"/>
        <path d="${phPath}"  fill="none" stroke="#16a34a" stroke-width="2"/>
        <path d="${tdsPath}" fill="none" stroke="#2563eb" stroke-width="2" stroke-dasharray="5 4"/>
      `;
    }

    function applyPanelToUI(p){
      const { device_id } = getActiveDevice();
      setText("deviceLabel", device_id);

      const s = (p && p.latest_sensor) ? p.latest_sensor : {};

      const ph   = safeNum(s.ph);
      const tds  = safeNum(s.tds);
      const wT   = safeNum(s.water_temp);
      const air  = safeNum(s.air_temp);
      const hum  = safeNum(s.humidity);
      const lit  = safeNum(s.drumLiters);

      if (ph  !== null) setGaugeValue("g_ph", ph);
      if (tds !== null) setGaugeValue("g_tds", tds);
      if (wT  !== null) setGaugeValue("g_waterTemp", wT);
      if (lit !== null) setGaugeValue("g_waterLevel", lit);
      if (air !== null) setGaugeValue("g_air", air);
      if (hum !== null) setGaugeValue("g_humidity", hum);

      setText("miniPh",   ph  === null ? "--" : ph.toFixed(2));
      setText("miniTds",  tds === null ? "--" : String(Math.round(tds)));
      setText("miniWT",   wT  === null ? "--" : (wT.toFixed(1) + " °C"));
      setText("miniWL",   lit === null ? "--" : (lit.toFixed(1) + " L"));
      setText("miniAir",  air === null ? "--" : (air.toFixed(1) + " °C"));
      setText("miniHum",  hum === null ? "--" : (hum.toFixed(0) + " %"));

      const ts = s.timestamp || s.logged_at || s.time || "";
      setText("lastSeen", ts ? ("Last update: " + ts) : "Last update: --");

      // Trend update
      pushHistory(ph, tds);
      renderTrendChart();
    }

    let _pollTimer = null;

    async function pollOnce(){
      try{
        const panel = await fetchPanel();
        applyPanelToUI(panel);
        setText("connPill", "Live");
      }catch(e){
        setText("connPill", "Offline");
      }
    }

    function startPolling(){
      stopPolling();
      pollOnce();
      _pollTimer = setInterval(pollOnce, POLL_MS);
    }

    function stopPolling(){
      if (_pollTimer) { clearInterval(_pollTimer); _pollTimer = null; }
    }

    // CCTV snapshot refresh
    let _snapTimer = null;
    function updateSnapshot(){
      const img = document.getElementById("snapshot");
      if (!img) return;
      img.src = SNAPSHOT_URL + "?rand=" + Date.now();
    }
    function startSnapshot(){
      stopSnapshot();
      updateSnapshot();
      _snapTimer = setInterval(updateSnapshot, SNAPSHOT_MS);
    }
    function stopSnapshot(){
      if (_snapTimer) { clearInterval(_snapTimer); _snapTimer = null; }
    }

    // Windy embed init
    function initWindy(){
      const frame = document.getElementById("windyFrame");
      if (!frame) return;

      // Note: use plain string concat (safe for older webviews)
      const src =
        "https://embed.windy.com/embed2.html"
        + "?lat=" + encodeURIComponent(latitude)
        + "&lon=" + encodeURIComponent(longitude)
        + "&zoom=11"
        + "&level=surface"
        + "&overlay=solarpower"
        + "&menu=&message=&marker=&calendar=now&pressure=&type=map&location=coordinates"
        + "&detail=&detailLat=" + encodeURIComponent(latitude)
        + "&detailLon=" + encodeURIComponent(longitude)
        + "&metricWind=km%2Fh&metricTemp=%C2%B0C&radarRange=-1";
      frame.src = src;
    }

    // Expose for DroidScript
    window.SHVF_DASH = {
      startPolling, stopPolling, pollOnce, getActiveDevice,
      startSnapshot, stopSnapshot, updateSnapshot
    };

    // INIT
    document.addEventListener("DOMContentLoaded", () => {
      DrawGaugePh("g_ph", "pH Level");
      DrawGaugeTds("g_tds", "TDS Level");
      DrawGauge_WaterTemp("g_waterTemp", "Water Temp");
      DrawGaugeWaterLevel("g_waterLevel", "Water Level");
      DrawGauge_Air("g_air", "Air Temp");
      DrawGaugeHumidity("g_humidity", "Humidity");

      initWindy();
      startSnapshot();
      startPolling();
    });
  </script>
</head>

<body>

  <!-- CCTV Snapshot -->
  <div class="card media-card">
    <div class="section-title">CCTV Live Snapshot</div>
    <img id="snapshot" class="snapshot" src="" alt="CCTV Snapshot" />
    <div class="hint">Auto-refresh every 4 seconds.</div>
  </div>

  <!-- Windy Solar Forecast -->
  <div class="card media-card">
    <div class="section-title">Solar Forecast (by Windy)</div>
    <div class="iframe-wrap">
      <iframe id="windyFrame" title="Windy Solar Forecast" src="about:blank"></iframe>
    </div>
    <div class="hint">If Windy doesn’t load inside your WebView, allow internet + mixed content in DroidScript WebView settings.</div>
  </div>

  <!-- Gauges -->
  <div class="grid">
    <div class="card gcard"><canvas id="g_ph"></canvas></div>
    <div class="card gcard"><canvas id="g_tds"></canvas></div>

    <div class="card gcard"><canvas id="g_waterTemp"></canvas></div>
    <div class="card gcard"><canvas id="g_waterLevel"></canvas></div>

    <div class="card gcard"><canvas id="g_air"></canvas></div>
    <div class="card gcard"><canvas id="g_humidity"></canvas></div>
  </div>

  <!-- Summary / status (no app header) -->
  <div class="card summary">
    <div class="summary-row">
      <div class="summary-left">
        <div class="summary-title">SmartHydroFarm Dashboard</div>
        <div class="summary-sub">Device: <span id="deviceLabel">--</span></div>
      </div>
      <div class="pill" id="connPill">Live</div>
    </div>

    <div class="status-grid">
      <div class="mini card"><div class="k">pH</div><div class="v" id="miniPh">--</div></div>
      <div class="mini card"><div class="k">TDS (ppm)</div><div class="v" id="miniTds">--</div></div>
      <div class="mini card"><div class="k">Water Temp</div><div class="v" id="miniWT">--</div></div>
      <div class="mini card"><div class="k">Water Level</div><div class="v" id="miniWL">--</div></div>
      <div class="mini card"><div class="k">Air Temp</div><div class="v" id="miniAir">--</div></div>
      <div class="mini card"><div class="k">Humidity</div><div class="v" id="miniHum">--</div></div>
    </div>

    <div style="margin-top:10px;font-size:12px;color:var(--muted);" id="lastSeen">
      Last update: --
    </div>
  </div>

  <!-- Trend Chart -->
  <div class="card trend-card">
    <div class="trend-head">
      <div class="section-title" style="margin:0;">Sensor Trend (last 20 polls)</div>
      <div class="trend-legend">
        <div><span style="color:#16a34a;">—</span> pH</div>
        <div><span style="color:#2563eb;">- -</span> TDS</div>
      </div>
    </div>
    <svg id="trendSvg" viewBox="0 0 320 130"></svg>
  </div>

</body>
</html>