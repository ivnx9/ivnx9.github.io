<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Control & Config (Mobile App Page)</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />

  <style>
    :root{
      --bg: #f6f7fb;
      --card: #ffffff;
      --text: #111827;
      --muted: #6b7280;
      --border: #e5e7eb;
      --dark: #111827;
      --shadow: 0 6px 18px rgba(17,24,39,0.06);
      --radius: 16px;
    }

    *{ box-sizing:border-box; margin:0; padding:0; font-family: Arial, sans-serif; }
    body{
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      overflow: hidden; /* app feel */
    }

    /* Page container (NO top header as requested) */
    .app-scroll{
      height: 100vh;
      overflow-y: auto;
      padding: 12px 12px 24px;
    }

    .mcard{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: var(--shadow);
      margin-bottom: 12px;
    }

    .mcard-head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      margin-bottom:12px;
    }

    .mcard-title{
      font-size: 14px;
      font-weight: 900;
      color: var(--text);
    }

    .mcard-sub{
      margin-top: 2px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
    }

    .badge{
      font-size: 11px;
      font-weight: 800;
      color: var(--text);
      background: #f3f4f6;
      border: 1px solid var(--border);
      padding: 6px 10px;
      border-radius: 999px;
      white-space: nowrap;
    }

    /* Toggle list */
    .toggle-list{
      border: 1px solid var(--border);
      border-radius: 14px;
      overflow: hidden;
      background: #fff;
    }
    .toggle-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 12px;
      border-bottom: 1px solid var(--border);
    }
    .toggle-row:last-child{ border-bottom: none; }

    .toggle-text{ flex:1; }
    .toggle-name{ font-size: 13px; font-weight: 900; color: var(--text); }
    .toggle-desc{ margin-top: 2px; font-size: 11px; color: var(--muted); }

    /* iOS-like switch (dark when ON) */
    .switch{ position: relative; display:inline-block; width: 48px; height: 28px; flex: 0 0 auto; }
    .switch input{ opacity:0; width:0; height:0; }
    .slider{
      position:absolute; inset:0; cursor:pointer;
      background: #d1d5db;
      transition: .2s;
      border-radius: 999px;
      border: 1px solid #cbd5e1;
    }
    .slider:before{
      content:"";
      position:absolute;
      height:22px; width:22px;
      left:3px; top:2px;
      background:#fff;
      border-radius:999px;
      transition:.2s;
      box-shadow: 0 4px 10px rgba(0,0,0,0.12);
    }
    .switch input:checked + .slider{
      background: var(--dark);
      border-color: var(--dark);
    }
    .switch input:checked + .slider:before{
      transform: translateX(20px);
    }

    .row-info{
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
      min-height: 16px;
    }

    /* Forms */
    .form-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top: 10px;
    }
    .field{ display:flex; flex-direction:column; gap:6px; }
    .field.full{ grid-column: 1 / -1; }

    .field label{
      font-size: 11px;
      color: var(--muted);
      font-weight: 700;
    }
    .field input, .field select{
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #fff;
      font-size: 13px;
      outline: none;
      color: var(--text);
    }
    .field input:focus, .field select:focus{
      border-color: var(--dark);
    }

    .btn-primary{
      margin-top: 12px;
      width: 100%;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid var(--dark);
      background: var(--dark);
      color: #fff;
      font-weight: 900;
      font-size: 13px;
      cursor: pointer;
      transition: transform .08s, box-shadow .2s;
    }
    .btn-primary:active{ transform: translateY(1px); }
    .btn-primary:disabled{
      opacity: .6;
      cursor: not-allowed;
    }

    .status{
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted);
      min-height: 16px;
    }

    /* Live status grid */
    .kv-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .kv{
      padding: 10px 12px;
      border-radius: 14px;
      background: #f9fafb;
      border: 1px solid var(--border);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .kv span{ font-size: 11px; color: var(--muted); font-weight: 700; }
    .kv b{ font-size: 13px; color: var(--text); font-weight: 900; }

    .divider{
      height: 1px;
      background: var(--border);
      margin: 12px 0;
    }

    .relay-badges{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .rb{
      padding: 10px 12px;
      border-radius: 14px;
      background: #f9fafb;
      border: 1px solid var(--border);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .rb span{ font-size: 12px; color: var(--muted); font-weight: 800; }

    .state{
      font-size: 11px;
      font-weight: 900;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #fff;
      color: var(--text);
      text-transform: uppercase;
    }
    .state.on{
      border-color: var(--dark);
      background: var(--dark);
      color: #fff;
      opacity: 1;
    }
    .state.off{
      opacity: .85;
    }

    /* extra-safe for tiny screens */
    @media (max-width: 360px){
      .form-grid, .kv-grid, .relay-badges{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>

  <!-- MOBILE CONTROL & CONFIG PAGE (NO TOP HEADER) -->
  <div class="app-scroll" id="controlPage">

    <!-- Automation & Relays -->
    <div class="mcard">
      <div class="mcard-head">
        <div>
          <div class="mcard-title">Automation & Relays</div>
          <div class="mcard-sub">When Automation is ON, manual relays may be ignored by the device.</div>
        </div>
        <span class="badge" id="ccDeviceBadge">Device: --</span>
      </div>

      <div class="toggle-list">
        <div class="toggle-row">
          <div class="toggle-text">
            <div class="toggle-name">Automation</div>
            <div class="toggle-desc">Use device auto rules</div>
          </div>
          <label class="switch">
            <input type="checkbox" id="ccAutoToggle">
            <span class="slider"></span>
          </label>
        </div>

        <div class="toggle-row">
          <div class="toggle-text">
            <div class="toggle-name">Water Pump</div>
            <div class="toggle-desc">Manual ON/OFF</div>
          </div>
          <label class="switch">
            <input type="checkbox" id="ccWaterToggle">
            <span class="slider"></span>
          </label>
        </div>

        <div class="toggle-row">
          <div class="toggle-text">
            <div class="toggle-name">Grow Light</div>
            <div class="toggle-desc">Manual ON/OFF</div>
          </div>
          <label class="switch">
            <input type="checkbox" id="ccGrowToggle">
            <span class="slider"></span>
          </label>
        </div>

        <div class="toggle-row">
          <div class="toggle-text">
            <div class="toggle-name">Solenoid Valve</div>
            <div class="toggle-desc">Manual ON/OFF</div>
          </div>
          <label class="switch">
            <input type="checkbox" id="ccSolenoidToggle">
            <span class="slider"></span>
          </label>
        </div>

        <div class="toggle-row">
          <div class="toggle-text">
            <div class="toggle-name">Mixer</div>
            <div class="toggle-desc">Manual ON/OFF</div>
          </div>
          <label class="switch">
            <input type="checkbox" id="ccMixerToggle">
            <span class="slider"></span>
          </label>
        </div>
      </div>

      <div class="row-info" id="ccRelayInfo">
        Tip: If Automation is ON, the device can override manual relays.
      </div>
    </div>

    <!-- Manual Dosing -->
    <div class="mcard">
      <div class="mcard-head">
        <div>
          <div class="mcard-title">Manual Dosing</div>
          <div class="mcard-sub">Dose using mL or ms. If both are set, ms is preferred.</div>
        </div>
      </div>

      <div class="form-grid">
        <div class="field full">
          <label>Channel</label>
          <select id="ccDoseChannel">
            <option value="A">Nutrient A</option>
            <option value="B">Nutrient B</option>
            <option value="PH_UP">pH Up</option>
            <option value="PH_DOWN">pH Down</option>
          </select>
        </div>

        <div class="field">
          <label>Dose by mL</label>
          <input id="ccDoseMl" type="number" min="0" step="0.1" placeholder="e.g. 1.5">
        </div>

        <div class="field">
          <label>Or dose by ms</label>
          <input id="ccDoseMs" type="number" min="0" step="10" placeholder="e.g. 1500">
        </div>
      </div>

      <button class="btn-primary" id="ccDoseBtn">Dose Now</button>
      <div class="status" id="ccDoseStatus"></div>
    </div>

    <!-- Plant Profile -->
    <div class="mcard">
      <div class="mcard-head">
        <div>
          <div class="mcard-title">Plant Profile</div>
          <div class="mcard-sub">Targets used by automation logic (device-side).</div>
        </div>
      </div>

      <div class="form-grid">
        <div class="field full">
          <label>Plant Name</label>
          <input id="ccPlantName" placeholder="lettuce">
        </div>

        <div class="field">
          <label>PPM Min</label>
          <input id="ccPpmMin" type="number" placeholder="min">
        </div>
        <div class="field">
          <label>PPM Max</label>
          <input id="ccPpmMax" type="number" placeholder="max">
        </div>

        <div class="field">
          <label>pH Target</label>
          <input id="ccPhTarget" type="number" step="0.1" placeholder="target">
        </div>
        <div class="field">
          <label>pH Min</label>
          <input id="ccPhMin" type="number" step="0.1" placeholder="min">
        </div>
        <div class="field">
          <label>pH Max</label>
          <input id="ccPhMax" type="number" step="0.1" placeholder="max">
        </div>

        <div class="field">
          <label>Lights ON (H)</label>
          <input id="ccOnH" type="number" min="0" max="23" placeholder="0-23">
        </div>
        <div class="field">
          <label>Lights ON (M)</label>
          <input id="ccOnM" type="number" min="0" max="59" placeholder="0-59">
        </div>
        <div class="field">
          <label>Lights OFF (H)</label>
          <input id="ccOffH" type="number" min="0" max="23" placeholder="0-23">
        </div>
        <div class="field">
          <label>Lights OFF (M)</label>
          <input id="ccOffM" type="number" min="0" max="59" placeholder="0-59">
        </div>
      </div>

      <button class="btn-primary" id="ccPlantSaveBtn">Save Plant Settings</button>
      <div class="status" id="ccPlantStatus"></div>
    </div>

    <!-- Live Status -->
    <div class="mcard">
      <div class="mcard-head">
        <div>
          <div class="mcard-title">Live Status</div>
          <div class="mcard-sub">Shows latest sensor & actual relay states.</div>
        </div>
        <span class="badge" id="ccLastUpdate">Updated: --</span>
      </div>

      <div class="kv-grid">
        <div class="kv"><span>pH</span><b id="ccLsPh">--</b></div>
        <div class="kv"><span>TDS</span><b id="ccLsTds">--</b></div>
        <div class="kv"><span>Water Temp</span><b id="ccLsWater">--</b></div>
        <div class="kv"><span>Air Temp</span><b id="ccLsAir">--</b></div>
        <div class="kv"><span>Humidity</span><b id="ccLsHum">--</b></div>
        <div class="kv"><span>Depth</span><b id="ccLsDepth">--</b></div>
        <div class="kv"><span>Drum Distance</span><b id="ccLsDrumD">--</b></div>
        <div class="kv"><span>Liters</span><b id="ccLsLiters">--</b></div>
      </div>

      <div class="divider"></div>

      <div class="relay-badges">
        <div class="rb"><span>Water</span><b class="state off" id="ccActWater">--</b></div>
        <div class="rb"><span>Grow</span><b class="state off" id="ccActGrow">--</b></div>
        <div class="rb"><span>Solenoid</span><b class="state off" id="ccActSol">--</b></div>
        <div class="rb"><span>Mixer</span><b class="state off" id="ccActMixer">--</b></div>
      </div>

      <div class="row-info">
        ACK rev: <b id="ccAckRev">--</b> â€¢ Dose ACK: <b id="ccAckDose">--</b>
      </div>
    </div>

  </div>

  <script>
    /* ============================================================
      FULL PAGE SCRIPT
      - Uses your existing API: api/webhook.php (cmd=panel + POST set_commands)
      - If you paste this into your app project, it should work.
      - You can remove the "demo defaults" below and rely on your app's globals.
    ============================================================ */

    /* ====== CONFIG ====== */
    const API_BASE = "https://smarthydrofarm.com/api/webhook.php";

    // Active device (load from storage if you already store it)
    let CURRENT_DEVICE_ID   = "SHVF-V1"; // localStorage.getItem("shvf_device_id")   || "SHVF-V1";
    let CURRENT_DEVICE_CODE = "12345"; // localStorage.getItem("shvf_device_code") || "12345";

    /* ====== Helpers ====== */
    function ccSetStatus(elId, text){
      const el = document.getElementById(elId);
      if (el) el.textContent = text || "";
    }
    function ccSetStateBadge(elId, isOn){
      const el = document.getElementById(elId);
      if (!el) return;
      el.classList.remove("on","off");
      el.classList.add(isOn ? "on" : "off");
      el.textContent = isOn ? "ON" : "OFF";
    }

    /* ====== API calls ====== */
    async function apiPanel(){
      const url = `${API_BASE}?cmd=panel`
        + `&device_id=${encodeURIComponent(CURRENT_DEVICE_ID)}`
        + `&device_code=${encodeURIComponent(CURRENT_DEVICE_CODE)}`;

      const res = await fetch(url, { credentials: "same-origin" });
      if (!res.ok) throw new Error("panel fetch failed: " + res.status);
      return await res.json();
    }

    async function apiSetCommands(body){
      const payload = {
        device_id:   CURRENT_DEVICE_ID,
        device_code: CURRENT_DEVICE_CODE,
        action:      "set_commands",
        ...body
      };

      const res = await fetch(API_BASE, {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(payload),
        credentials: "same-origin"
      });

      if (!res.ok) throw new Error("set_commands failed: " + res.status);
      return await res.json();
    }

    /* ====== UI Bindings ====== */
    function bindControlMobilePage(){
      // badge
      const badge = document.getElementById("ccDeviceBadge");
      if (badge) badge.textContent = "Device: " + (CURRENT_DEVICE_ID || "--");

      const autoEl = document.getElementById("ccAutoToggle");
      const wEl    = document.getElementById("ccWaterToggle");
      const gEl    = document.getElementById("ccGrowToggle");
      const sEl    = document.getElementById("ccSolenoidToggle");
      const mEl    = document.getElementById("ccMixerToggle");

      autoEl.onchange = async () => {
        try{
          await apiSetCommands({ auto: autoEl.checked });
          ccSetStatus("ccRelayInfo", "Saved: Automation " + (autoEl.checked ? "ON" : "OFF"));
        }catch(e){
          ccSetStatus("ccRelayInfo", "Error: " + e.message);
        }
      };

      wEl.onchange = async () => { try{ await apiSetCommands({ water:    wEl.checked }); }catch(e){ console.error(e); } };
      gEl.onchange = async () => { try{ await apiSetCommands({ grow:     gEl.checked }); }catch(e){ console.error(e); } };
      sEl.onchange = async () => { try{ await apiSetCommands({ solenoid: sEl.checked }); }catch(e){ console.error(e); } };
      mEl.onchange = async () => { try{ await apiSetCommands({ mixer:    mEl.checked }); }catch(e){ console.error(e); } };

      // dosing
      document.getElementById("ccDoseBtn").onclick = async () => {
        const btn = document.getElementById("ccDoseBtn");
        const ch  = document.getElementById("ccDoseChannel").value;
        const ml  = parseFloat(document.getElementById("ccDoseMl").value || "0");
        const ms  = parseInt(document.getElementById("ccDoseMs").value || "0", 10);

        ccSetStatus("ccDoseStatus", "Queueing dose...");
        btn.disabled = true;

        // monotonic dose_req per device
        const key = `dose_req_seq_${CURRENT_DEVICE_ID}`;
        let nextReq = parseInt(localStorage.getItem(key) || "100", 10) + 1;
        localStorage.setItem(key, String(nextReq));

        const payload = { dose_req: nextReq, dose_channel: ch };
        if (!isNaN(ms) && ms > 0) payload.dose_ms = ms;
        else if (!isNaN(ml) && ml > 0) payload.dose_ml = ml;

        try{
          const r = await apiSetCommands(payload);
          ccSetStatus("ccDoseStatus", `Queued dose #${r.dose_req || nextReq} (${r.dose_channel || ch})`);
        }catch(e){
          ccSetStatus("ccDoseStatus", "Dose failed: " + e.message);
        }finally{
          btn.disabled = false;
        }
      };

      // plant save
      document.getElementById("ccPlantSaveBtn").onclick = async () => {
        const btn = document.getElementById("ccPlantSaveBtn");
        ccSetStatus("ccPlantStatus", "Saving...");
        btn.disabled = true;

        const body = {
          plant_name: document.getElementById("ccPlantName").value || undefined,
          ppm_min:    parseInt(document.getElementById("ccPpmMin").value || "0", 10),
          ppm_max:    parseInt(document.getElementById("ccPpmMax").value || "0", 10),
          ph_target:  parseFloat(document.getElementById("ccPhTarget").value || "0"),
          ph_min:     parseFloat(document.getElementById("ccPhMin").value || "0"),
          ph_max:     parseFloat(document.getElementById("ccPhMax").value || "0"),
          on_h:       parseInt(document.getElementById("ccOnH").value || "0", 10),
          on_m:       parseInt(document.getElementById("ccOnM").value || "0", 10),
          off_h:      parseInt(document.getElementById("ccOffH").value || "0", 10),
          off_m:      parseInt(document.getElementById("ccOffM").value || "0", 10),
        };

        // clean NaNs
        const clean = {};
        for (const k in body){
          if (body[k] !== undefined && !Number.isNaN(body[k])) clean[k] = body[k];
        }

        try{
          const r = await apiSetCommands(clean);
          ccSetStatus("ccPlantStatus", `Saved (rev ${r.rev ?? "-"})`);
        }catch(e){
          ccSetStatus("ccPlantStatus", "Save failed: " + e.message);
        }finally{
          btn.disabled = false;
        }
      };
    }

    /* ====== Apply panel JSON to UI ====== */
    function applyPanel(p){
      if (!p) return;

      // show active device
      const badge = document.getElementById("ccDeviceBadge");
      if (badge) badge.textContent = "Device: " + (CURRENT_DEVICE_ID || "--");

      // desired states -> toggles
      const desiredAuto   = !!(p.desired?.auto     ?? p.auto);
      const desiredWater  = !!(p.desired?.water    ?? p.water);
      const desiredGrow   = !!(p.desired?.grow     ?? p.grow);
      const desiredSol    = !!(p.desired?.solenoid ?? p.solenoid);
      const desiredMixer  = !!(p.desired?.mixer    ?? p.mixer);

      const autoEl = document.getElementById("ccAutoToggle");
      const wEl    = document.getElementById("ccWaterToggle");
      const gEl    = document.getElementById("ccGrowToggle");
      const sEl    = document.getElementById("ccSolenoidToggle");
      const mEl    = document.getElementById("ccMixerToggle");

      if (autoEl) autoEl.checked = desiredAuto;
      if (wEl) wEl.checked = desiredWater;
      if (gEl) gEl.checked = desiredGrow;
      if (sEl) sEl.checked = desiredSol;
      if (mEl) mEl.checked = desiredMixer;

      // plant config
      if (p.plant){
        const setVal = (id, v) => { const el = document.getElementById(id); if (el) el.value = (v ?? ""); };
        setVal("ccPlantName", p.plant.name);
        setVal("ccPpmMin", p.plant.ppm_min);
        setVal("ccPpmMax", p.plant.ppm_max);
        setVal("ccPhTarget", p.plant.ph_target);
        setVal("ccPhMin", p.plant.ph_min);
        setVal("ccPhMax", p.plant.ph_max);
        setVal("ccOnH", p.plant.on_h);
        setVal("ccOnM", p.plant.on_m);
        setVal("ccOffH", p.plant.off_h);
        setVal("ccOffM", p.plant.off_m);
      }

      // live sensor
      if (p.latest_sensor){
        const s = p.latest_sensor;
        const put = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = (val ?? "--"); };
        put("ccLsPh", s.ph);
        put("ccLsTds", (s.tds ?? s.ppm));
        put("ccLsWater", s.water_temp);
        put("ccLsAir", s.air_temp);
        put("ccLsHum", s.humidity);
        put("ccLsDepth", s.drumDepth);
        put("ccLsDrumD", s.drumD);
        put("ccLsLiters", s.drumLiters);

        const upd = document.getElementById("ccLastUpdate");
        if (upd) upd.textContent = "Updated: " + (s.timestamp || "now");
      }

      // actual relays
      const a = p.actual || {};
      ccSetStateBadge("ccActWater", !!a.water);
      ccSetStateBadge("ccActGrow", !!a.grow);
      ccSetStateBadge("ccActSol",  !!a.solenoid);
      ccSetStateBadge("ccActMixer",!!a.mixer);

      const ackRev  = document.getElementById("ccAckRev");
      const ackDose = document.getElementById("ccAckDose");
      if (ackRev)  ackRev.textContent  = (a.ack_rev  ?? "--");
      if (ackDose) ackDose.textContent = (a.dose_ack ?? "--");
    }

    /* ====== Poll loop ====== */
    async function pollPanel(){
      try{
        const p = await apiPanel();
        applyPanel(p);
      }catch(e){
        console.error("panel error:", e);
      }
    }

    /* ====== Init ====== */
    document.addEventListener("DOMContentLoaded", () => {
      bindControlMobilePage();
      pollPanel();
      setInterval(pollPanel, 3000);
    });
  </script>

</body>
</html>